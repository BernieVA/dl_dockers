name: Upload Multiple Artifacts

on: [push]

jobs:
  upload-multiple-artifacts:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup environment
      run: |
        # Setup your environment as necessary
        mkdir files
        # Example: Generate files dynamically. Adjust this as needed.
        echo "Generating files..."
        1..5 | ForEach-Object { Out-File -FilePath "files/File$_.txt" -InputObject "Content for file $_" }

    - name: Upload files as individual artifacts
      run: |
        $files = Get-ChildItem ./files -File
        foreach ($file in $files) {
          $name = $file.Name
          $path = $file.FullName
          echo "Uploading $name as an artifact..."
          # This uses a PowerShell script to dynamically create the upload step for each file
          echo "::set-output name=name::$name"
          echo "::set-output name=path::$path"
        } | ForEach-Object { gh workflow run upload-artifact.yml --field artifact-name=$_name --field path=$_path }
      shell: pwsh

    # Dynamic artifact upload (Example using matrix strategy for demonstration; adapt as needed)
    - name: Upload artifact dynamically
      uses: actions/upload-artifact@v3
      with:
        name: ${{fromJson(needs.upload-multiple-artifacts.outputs.artifacts).name}}
        path: ${{fromJson(needs.upload-multiple-artifacts.outputs.artifacts).path}}
